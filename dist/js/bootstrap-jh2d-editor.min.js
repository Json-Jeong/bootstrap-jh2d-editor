/*! bootstrap-jh2d-editor 2015-07-13 */
$(document).ajaxError(function(a,b,c,d){console.log(d)}).ajaxComplete(function(){}).ready(function(){var a=uuid.noConflict(),b=function(a){this.modal=a,this.modal.on("shown.bs.modal",$.proxy(this.onShown,this)),this.modal.on("hide.bs.modal",$.proxy(this.onHide,this)),$(".btn-primary",this.modal).on("click",$.proxy(this.refresh,this))};b.prototype={constructor:b,show:function(){null==this.files||0===this.files.length?this.refresh():this.modal.modal("show")},hide:function(){this.modal.modal("hide")},refresh:function(){$.get("serv/files",$.proxy(this.filesLoaded,this))},onShown:function(){var a=this;this.modal.on("click.open",".row a",function(){var b=$(this).data("file-id");$.get("serv/files/"+b,$.proxy(a.fileLoaded,a))})},onHide:function(){this.modal.off("click.open"),console.log("onhide")},filesLoaded:function(a){this.files=a.data;var b=$(".modal-body",this.modal);b.empty(),b.append(this.layout1()),this.modal.modal("show")},fileLoaded:function(a){console.log(a),this.modal.modal("hide");var b=JSON.parse(a.data.file_content);this.modal.trigger({type:"open.file",file:b})},layout1:function(){for(var a=$('<div class="container-fluid"><div class="row"></div></div>'),b=$(".row",a),c=0;c<this.files.length;c++){var d=this.files[c];b.append($('<div class="col-xs-4"><i class="fa fa-file-o"></i>&nbsp;<a href="#" data-file-id="'+d.file_id+'" title="'+d.file_id+"\n"+d.file_name+"\n"+d.created+'">'+d.file_name+"</a></div>"))}return a}};var c=function(a){this.element=a,this.items=$("li",this.element),this.createCount=1,this.element.on("click",".closeTab",$.proxy(this.onCloseTab,this)),this.element.on("click","a",$.proxy(this.onSelectTab,this))};c.prototype={constructor:c,createTag:function(a){var b=$('<li data-file-uuid="'+a.uuid+'"><a href="#" data-toggle="tab" title="'+a.title+'"><i class="fa fa-file-o"></i>&nbsp;<span class="gb-filetitle">'+a.title+'</span><i class="gb-unsaved"></i><button type="button" class="close closeTab" aria-label="Close"><span aria-hidden="true">&times;</span></button></a></li>').insertBefore(this.items.last());return this.element.trigger({type:"create.tab",value:a}),b},onCloseTab:function(a){a.stopPropagation();var b=$(a.target),c=b.parent().parent();this.closeTab(c)},closeTab:function(a){var b=this.activeUuid();a.remove(),this.element.trigger({type:"close.tab",value:a.data("file-uuid")}),this.lastUuid&&this.lastUuid!==b?$("li[data-file-uuid="+this.lastUuid+"] a",this.element).tab("show"):$("li:first a",this.element).tab("show"),this.lastUuid=null},closeActive:function(){this.closeTab($("li.active",this.tabs))},activeUuid:function(){return $("li.active",this.tabs).data("file-uuid")},onSelectTab:function(a){a.preventDefault();var b=$(a.target).closest("a"),c=b.parent(),d=c.data("file-uuid"),e=this.activeUuid();null!=d&&-1!==d?d!==e&&(b.tab("show"),this.element.trigger({type:"select.tab",value:d}),this.lastUuid=e):(this.createUntitled(),this.lastUuid=e)},openFile:function(a){var b=$("li[data-file-uuid="+a.uuid+"]",this.element);0===b.size()&&(b=this.createTag(a)),$("a",b).tab("show")},createUntitled:function(){var b={title:"Untitled"+this.createCount,uuid:a.v1()},c=this.createTag(b);return this.createCount++,$("a",c).tab("show"),b}};var d=function(a){this.element=a,a.on("click",".btn-group button, .btn-group a",$.proxy(this.onItemClick,this))};d.prototype={constructor:d,onItemClick:function(a){var b=$(a.target).closest("[data-gb-act-type]");b.addClass("active"),b.siblings().removeClass("active");var c=b.data("gb-act-type"),d=b.data("gb-act-do");if(c){var e=c+".toolbar";this.element.trigger({type:e,which:d,relatedTarget:b})}}};var e={a3:[297,420],a4:[210,279],a5:[148,210],a6:[105,148]},f={portrait:[1,0],lanscape:[0,1]},g=[{strokeStyle:"#000",strokeSize:2,fillStyle:null,textOpt:null,shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{strokeStyle:"#428bca",strokeSize:2,fillStyle:null,textOpt:null,shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{strokeStyle:"#5cb85c",strokeSize:2,fillStyle:null,textOpt:null,shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{strokeStyle:"#5bc0de",strokeSize:2,fillStyle:null,textOpt:null,shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{strokeStyle:"#f0ad4e",strokeSize:2,fillStyle:null,textOpt:null,shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{strokeStyle:"#d9534f",strokeSize:2,fillStyle:null,textOpt:null,shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{fillStyle:"#000",strokeStyle:"#000",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{fillStyle:"#428bca",strokeStyle:"#2069a8",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{fillStyle:"#5cb85c",strokeStyle:"#2a9529",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{fillStyle:"#5bc0de",strokeStyle:"#17809a",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{fillStyle:"#f0ad4e",strokeStyle:"#a06909",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{fillStyle:"#d9534f",strokeStyle:"#95100a",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:null,shadowOffset:null,shadowBlur:null,gradient:null},{fillStyle:"#000",strokeStyle:"#fff",strokeSize:6,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:null},{fillStyle:"#428bca",strokeStyle:"#fff",strokeSize:6,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:null},{fillStyle:"#5cb85c",strokeStyle:"#fff",strokeSize:6,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:null},{fillStyle:"#5bc0de",strokeStyle:"#fff",strokeSize:6,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:null},{fillStyle:"#f0ad4e",strokeStyle:"#fff",strokeSize:6,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:null},{fillStyle:"#d9534f",strokeStyle:"#fff",strokeSize:6,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:null},{fillStyle:"#eee",strokeStyle:"#000",strokeSize:2,textOpt:{color:"#000"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#86bffe",strokeStyle:"#2069a8",strokeSize:2,textOpt:{color:"#000"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#cfffcf",strokeStyle:"#2a9529",strokeSize:2,textOpt:{color:"#000"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#9ff4ff",strokeStyle:"#17809a",strokeSize:2,textOpt:{color:"#000"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#f4ef8f",strokeStyle:"#a06909",strokeSize:2,textOpt:{color:"#000"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#fc978f",strokeStyle:"#95100a",strokeSize:2,textOpt:{color:"#000"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#000",strokeStyle:"#000",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#428bca",strokeStyle:"#2069a8",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#5cb85c",strokeStyle:"#2a9529",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#5bc0de",strokeStyle:"#17809a",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#f0ad4e",strokeStyle:"#a06909",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2},{fillStyle:"#d9534f",strokeStyle:"#95100a",strokeSize:2,textOpt:{color:"#fff"},shadowAngle:Math.PI/2,shadowOffset:1,shadowBlur:2,gradient:-2}],h=function(a){return this.inArray(["x","y","w","h","ex","dx","dy","hz","text"],a)},i=function(a){this.element=a,this.undoPool={},this.undoPoolMaxSize=10,this.undoCount=0;var e=$("#fileExplorerModal");this.openFileDlg=new b(e),e.on("open.file",$.proxy(this.onFileOpen,this));var f=$("#toolbar");this.toolbar=new d(f),f.on("file.toolbar",$.proxy(this.onToolbarFile,this)),f.on("shape.toolbar",$.proxy(this.onToolbarShape,this)),f.on("edit.toolbar",$.proxy(this.onToolbarEdit,this)),f.on("zoom.toolbar",$.proxy(this.onToolbarZoom,this)),this.saveFileDlg=$("#fileSaveModal").on("show.bs.modal",$.proxy(this.saveDlgShow,this)).on("shown.bs.modal",$.proxy(this.saveDlgShown,this)).on("hidden.bs.modal",$.proxy(this.saveDlgHidden,this));var g=$("#tab_files");this.tabs=new c(g),g.on("close.tab",$.proxy(this.onCloseTab,this)),g.on("select.tab",$.proxy(this.onSelectTab,this)),g.on("create.tab",$.proxy(this.onCreateTab,this)),g.on("shown.bs.tab",'a[data-toggle="tab"]',$.proxy(this.onShownTab,this));var h=$('<canvas style="position:relative"></canvas>');this.textInput=$('<div class="gb-pane-hide gb-text-edit" contentEditable="true"></div>'),this.element.prepend(h),this.element.append(this.textInput);var i=h[0];i.width=this.element.width()-5,i.height=this.element.height()-5,this.jh2d=jh2d.instance(i,{background:1}).show(),this.jh2d.setActionstartListener($.proxy(this.onActionstart,this)),this.jh2d.setActiondoneListener($.proxy(this.onActiondone,this)),this.canvas=h,this.openFiles=[],this.tabs.createUntitled(),h.on("mouseup",$.proxy(this.onCanvasMouseup,this)),h.on("dblclick",$.proxy(this.onCanvasDblClick,this)),h.on("contextmenu",$.proxy(this.onContextMenu,this)),this.selectedCtxMenu=$(".selectedCtxMenu",this.element),this.selectedCtxMenu.on("click",".dropdown-menu a",$.proxy(this.onClickCxtMenu,this));var j=$("#shapestyle-dialog");j.shapeStyleDialog(),j.on("optionChange",$.proxy(this.onSsdlgOptChange,this)),j.on("shown.bs.modal",$.proxy(this.onSsdlgShow,this)),this.ssdlg=j,$(document).bind("keydown","del backspace Ctrl+a Ctrl+c Ctrl+v Ctrl+n Ctrl+w Ctrl+z Ctrl+y Ctrl+s",$.proxy(this.keyboard,this)),this.pasteCount=0,this.dragPanel=$("#accordion"),this.dragPanel.on("mousedown",'[class*="gb-ic-x"]',$.proxy(this.onDragPanel,this)),this.printFileDlg=$("#printFileModal"),this.printFileDlg.on("shown.bs.modal",$.proxy(this.onPrintFileDlgShown,this)),$("select",this.printFileDlg).on("change",$.proxy(this.onPrintOptChange,this)),this.printOption={size:"a4",orientation:"portrait"},this.printFileDlg.on("click",".btn-primary",$.proxy(this.onPrint,this));var k=$("canvas",this.printFileDlg)[0];this.printCanvas=k,this.printJh2d=jh2d.instance(k)};i.prototype={constructor:i,onToolbarFile:function(a){switch(a.which){case"new":this.newFile();break;case"print":this.printFile();break;default:this[a.which]()}},open:function(){this.openFileDlg.show()},newFile:function(){this.tabs.createUntitled()},printFile:function(){var a=this.printCanvas,b=this.canvas.width(),c=1122.5;a.width=c;var d=(c-b)/b+1,e=this.canvas.height()*d;a.height=e;var f=this.getCtxFile(),g=jh2d.extend({allScale:d},f.data.options);delete g.background,this.printJh2d.setData(f.data.sprites,g),this.printJh2d.update();var h=$("[id=printSize]",this.printFileDlg),i=$("[id=printOrientation]",this.printFileDlg),j=a.toDataURL();this.printOption.dataUrl=j,this.printOption.size=h.val(),this.printOption.orientation=i.val(),$(".gb-preview-page",this.printFileDlg).css("background-image","url("+j+")"),this.printFileDlg.modal("show")},onPrintFileDlgShown:function(){var a=$(".gb-preview-container",this.printFileDlg),b=a.width(),c=b/1122.5;a.height(1587.4*c),this.printOption.scale=c,this.setPrintPage()},setPrintPage:function(){var a=$(".gb-preview-container",this.printFileDlg),b=this.printOption,c=b.scale,d=e[b.size],g=f[b.orientation],h=(d[0]*g[0]+d[1]*g[1])/25.4*96,i=(d[1]*g[0]+d[0]*g[1])/25.4*96,j=$(".gb-preview-page",a);j.css({width:h*c,height:i*c})},onPrintOptChange:function(a){var b=$(a.target),c=b.attr("id"),d=b.val();switch(c){case"printSize":this.printOption.size=d;break;case"printOrientation":this.printOption.orientation=d}this.setPrintPage()},onPrint:function(){var a=this.printOption,b=window.open("","","height=1,width=1,top=10000,left=10000,toolbar=no,menubar=no,scrollbars=no,resizable=no,location=no,status=no");b.document.open(),b.document.write('<img src="'+a.dataUrl+'"/>'),b.document.close(),b.focus(),b.print(),b.close()},save:function(){var a=this.getCtxFile();a.id?$.post("serv/files/"+a.id+"/save",{content:JSON.stringify(a)},function(a,b){console.log(b)}):this.saveFileDlg.modal("show")},doSave:function(){var a=this.getCtxFile(),b=$("input",this.saveFileDlg),c=b.val();c&&(a.title=c),$.post("serv/files",{content:JSON.stringify(a)},$.proxy(this.onFileSave,this))},onFileSave:function(a){var b=this.getCtxFile(),c=$(".btn-primary",this.saveFileDlg);c.button("reset"),0===a.code&&(b.id=a.data.fileId,$("li.active .gb-filetitle",this.tabs.element).text(b.title),this.saveFileDlg.modal("hide"))},saveDlgShow:function(){var a=$("input",this.saveFileDlg),b=this.getCtxFile();a.val(b.title)},saveDlgShown:function(){var a=$("input",this.saveFileDlg);a.select().focus();var b=$(".btn-primary",this.saveFileDlg);b.on("click.saveFileDlg",$.proxy(this.doSave,this))},saveDlgHidden:function(){var a=$(".btn-primary",this.saveFileDlg);a.off("click.saveFileDlg")},onFileOpen:function(a){var b=a.file;this.tabs.openFile(b)},onCloseTab:function(a){var b=a.value,c=this.indexOfFiles(b);-1!==c&&this.openFiles.splice(c,1),delete this.undoPool[b]},onSelectTab:function(a){var b=a.value;this.selectFile(b)},selectFile:function(a){var b=this.indexOfFiles(a),c=this.openFiles[b];this.jh2d.setData(c.data.sprites,c.data.options),this.jh2d.update()},getCtxFile:function(){var a=this.tabs.activeUuid(),b=this.indexOfFiles(a),c=this.openFiles[b];return c},setCtxFile:function(a){var b=this.tabs.activeUuid(),c=this.indexOfFiles(b);this.openFiles[c]=a},onCreateTab:function(a){var b=a.value.uuid,c=a.value;c.data={sprites:[],options:{background:1}},this.openFiles[this.openFiles.length]=c,this.undoPool[b]=[]},onShownTab:function(a){var b=$(a.target).parent().data("file-uuid");this.selectFile(b)},indexOfFiles:function(a){for(var b=0;b<this.openFiles.length;b++){var c=this.openFiles[b];if(c.uuid===a)return b}return-1},jh2dOption:function(a,b){for(var c in b){var d=c.indexOf("jh");if(0===d){var e=b[c],f=c.substring(2),g=f.substring(0,1).toLowerCase()+f.substring(1);a[g]=e}}return a},onToolbarShape:function(a){switch(a.which){case"text":this.jh2d.setDisabled(!0),this.canvas[0].style.cursor="text",this.clickWhich="inputText";break;default:this.reset();var b=this.jh2dOption({type:a.which,fillStyle:"#fff"},a.relatedTarget.data()),c=a.relatedTarget.data("gb-act-mode");this.jh2d.newMode(b,c),b.conn&&this.jh2d.connectMode()}},onToolbarEdit:function(a){var b=this.jh2d.getCurIndex(),c=a.relatedTarget,d=c.data("gb-act-val");switch(a.which){case"brush":-1!==b&&(this.copyStyle=jh2d.extend({},this.jh2d.getSprite(b),!0,h)),this.clickWhich="brushstyle";break;case"quickstyle":-1!==b&&(jh2d.extend(this.jh2d.getSprite(b),g[d],!0),this.jh2d.update());break;case"undo":this.undo();break;case"repeat":this.repeat()}},onToolbarZoom:function(a){var b=this.jh2d,c=b.getScale(),d=a.relatedTarget,e=d.data("gb-act-val");switch(a.which){case"set":c=parseFloat(e);break;default:c=e>0?Math.floor(10*c):Math.ceil(10*c),c+=10*e,c/=10}b.zoom(c);var f=null;f=d.is("a")?d.closest(".dropdown-menu").siblings(".dropdown-toggle"):d.siblings(".dropdown-toggle"),f.children("span").first().text(Math.ceil(100*c)+"%")},brushStyle:function(){for(var a=this.jh2d.getSelecteds(),b=0;b<a.length;b++){var c=a[b];jh2d.extend(c,this.copyStyle,!0)}this.jh2d.update()},reset:function(){this.clickWhich=null,this.lastClickWhich=null,this.canvas[0].style.cursor="default",this.textInput.hide()},onCanvasMouseup:function(a){var b=a.originalEvent,c=b.offsetX||b.layerX,d=b.offsetY||b.layerY,e=this.canvas.offset(),f=this.textInput,g=null;switch(this.clickWhich){case"inputText":if(this.lastClickWhich!==this.clickWhich)this.textInput.removeAttr("style"),this.textInput.css({position:"absolute",display:"block",overflow:"auto",resize:"both",border:"1px solid #ccc",left:c,top:d,minHeight:24}).text("").focus();else{var h=f.html(),i=f.offset();if(this.reset(),""!==h){var j=this.jh2d.getScale();h=h.replace(/\n/g,""),g={type:"rect",x:(i.left-e.left)/j,y:(i.top-e.top+4)/j,w:f.width(),h:f.height(),text:h,style:0,textOpt:{align:6}},this.jh2d.add(g),this.jh2d.update(),this.jh2d.setDisabled(!1)}}break;case"updateText":var k=this.jh2d.getCurIndex();g=this.jh2d.getSprite(k),g.text=f.html().replace(/\n/g,""),0===g.style&&jh2d.extend(g,{w:f.width(),h:f.height()},!0),this.reset(),this.jh2d.update(),this.jh2d.setDisabled(!1);break;case"brushstyle":this.brushStyle()}this.lastClickWhich=this.clickWhich},onActiondone:function(a,b){var c=b.selectedIndexs;switch(a){case 0:case 16:var d=$(".ssdlg-toggle",this.element);if(c.length>0){var e=b.curIndex,f=this.jh2d.data[-1===e?c[0]:e],g=this.jh2d.getScale();d.css({display:"block",left:(f.x+f.w)*g+10,top:f.y*g});var h=$('a[data-ssdlg-tabid="tab_image"]',d);f.img?(h.removeClass("hidden"),h.addClass("show")):(h.removeClass("show"),h.addClass("hidden"))}else d.hide(),this.selectedCtxMenu.hide()}0!==a&&a!==jh2d.ACT_SELECT&&this.addUndo()},onCanvasDblClick:function(a){var b=a.originalEvent,c=this.findIndByEvt(b);if(-1!==c){var d=this.jh2d.getSprite(c),e=this.jh2d.getScale(),f=d.x+d.w/4,g=d.y+d.h/4,h=jh2d.DEF_TEXT_OPT,i=15,j=d.w;if(d.text){h=d.textOpt;var k=h.x,l=h.y;j=h.w,f=k*e,g=l*e,d.rotate&&(f=d.x,g=d.y)}this.textInput.css({display:"block",left:f,top:g,minWidth:Math.max(d.w,j)*e,minHeight:24,fontFamily:h.font,fontStyle:h.style,fontWeight:h.weight,fontSize:h.size+"px",color:h.color,backgroundColor:"#fff",lineHeight:i+"px",overflow:"auto",resize:"both"}).focus().html(d.text||""),this.placeCaretAtEnd(this.textInput[0]),d.text="",this.jh2d.update(),this.clickWhich="updateText",this.jh2d.setDisabled(!0)}},placeCaretAtEnd:function(a){if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();b.selectNodeContents(a),b.collapse(!1);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if("undefined"!=typeof document.body.createTextRange){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}},findIndByEvt:function(a){var b=a.offsetX||a.layerX,c=a.offsetY||a.layerY,d=this.jh2d.getScale();return b/=d,c/=d,this.jh2d.indexOf(b,c)},onContextMenu:function(a){var b=a.originalEvent,c=b.offsetX||b.layerX,d=b.offsetY||b.layerY,e=this.jh2d.getCurIndex(),f=this.selectedCtxMenu;return-1!==e?($(".dropdown-submenu",f).addClass("disabled"),f.css({display:"block",left:c,top:d}),this.jh2d.getSelectedCount()>1&&$(".dropdown-submenu",f).removeClass("disabled")):f.hide(),!1},onClickCxtMenu:function(a){var b=this.jh2d;$(a.delegateTarget).hide();var c=$(a.target).data("gb-act-do"),d=this.jh2d.getCurIndex();switch(this.addUndo(),c){case"up":b.moveUp(d);break;case"down":b.moveDown(d);break;case"top":b.moveTop(d);break;case"bottom":b.moveBottom(d);break;case"grp":b.group();break;case"ungrp":b.ungroup();break;case"align-right":b.align(1);break;case"align-top":b.align(2);break;case"align-left":b.align(4);break;case"align-bottom":b.align(8);break;case"align-vcenter":b.align(5);break;case"align-hcenter":b.align(10)}this.jh2d.update()},onSsdlgOptChange:function(a){var b=this.jh2d.getCurIndex();if(-1!==b){var c=this.jh2d.getSprite(b),d=null;switch(this.addUndo(),a.key){case"r":c.rotate=a.val*Math.PI/180;break;case"gradient":var e=parseInt(a.val/4),f=a.val%4;switch(c.gradientType=0,c.gradientCnt=2,e){case 0:c.gradient=1;break;case 1:c.gradient=2;break;case 2:c.gradient=3;break;case 3:c.gradient=6;break;case 4:c.gradientType=1,c.gradient=15;break;case 5:c.gradientType=1,c.gradient=2>f?3:6}f%2!==0&&(c.gradient*=-1),5!==e&&f>1&&(c.gradientCnt=3),c.fillStyle=c.fillStyle||"#eee",c.style|=1;break;case"strokeSize":d=c.style||3,0===a.val?d&=-3:d|=2,c.style=d,c[a.key]=a.val;break;case"strokeStyle":if(d=c.style||3,null==a.val)d&=-3;else{c[a.key]=a.val;var g=$(a.target).shapeStyleDialog("option");g.strokeSize&&(d|=2,c.strokeSize=g.strokeSize)}c.style=d;break;case"fillStyle":d=c.style||3,null==a.val?d&=-2:d|=1,c.style=d,c[a.key]=a.val;break;case"alpha":c[a.key]=a.val/100;break;case"img":c[a.key]=a.val;break;case"shadow":8===a.val?c.shadowOffset=0:c.shadowOffset=5,c.shadowAngle=a.val*Math.PI/4;break;default:if(0===a.key.indexOf("font-")){var h=a.key.substring(5);c.textOpt=c.textOpt||{},c.textOpt[h]=a.val}else c[a.key]=a.val}this.jh2d.update()}},onSsdlgShow:function(a){var b=$(a.relatedTarget),c=b.data("ssdlg-tabid"),d=$('a[href="#'+c+'"]',this.ssdlg.element);"tab_image"===c&&d.parent().is(".active")?this.ssdlg.shapeStyleDialog("imgpickerUpdate"):d.tab("show")},keyboard:function(a){if($(a.target).is(".gb-text-edit"))return!0;if(a.ctrlKey)switch(String.fromCharCode(a.which).toLowerCase()){case"a":this.jh2d.selectAll().update();break;case"c":var b=this.jh2d.getSelecteds();b.length>0&&(this.clipboard=b);break;case"v":if(null!=this.clipboard){for(var c=jh2d.clone(this.clipboard),d=0;d<c.length;d++){var e=c[d];e.x+=10*(1+this.pasteCount),e.y+=10*(1+this.pasteCount)}this.jh2d.add(c).update(),this.pasteCount++,this.addUndo()}break;case"n":this.newFile();break;case"w":this.tabs.closeActive();break;case"z":this.undo();break;case"y":this.repeat();break;case"s":this.save()}else switch(jQuery.hotkeys.specialKeys[a.which]){case"del":case"backspace":this.jh2d.removeSelected()&&(this.jh2d.update(),this.addUndo())}return!1},onDragPanel:function(a){var b=$(a.target),c=b.data("gb-act-do");if(c){var d={type:c,w:160,h:80,fillStyle:"#fff"},e=b.data();this.jh2d.newMode(this.jh2dOption(d,e),jh2d.ACT_NEW_DROP)}return a.preventDefault(),!1},addUndo:function(){var a=this.tabs.activeUuid(),b=this.jh2d;this.undoPool[a]||(this.undoPool[a]=[]);var c=this.undoCount,d={data:{sprites:jh2d.clone(b.data),options:jh2d.clone(b.options)}};c>0?(this.undoPool[a].splice(this.undoPool[a].length-c,c,d),this.undoCount=0):(this.undoPool[a].length>=this.undoPoolMaxSize&&this.undoPool[a].shift(),this.undoPool[a].push(d))},undo:function(){var a=this.tabs.activeUuid(),b=this.undoPool[a],c=this.jh2d,d=b.length-2-this.undoCount;if(d>=0){var e=b[d];c.setData(e.data.sprites,e.data.options),c.update(),this.undoCount++,this.setCtxFile(e)}else b.length>1&&-1===d&&(c.setData([],{background:1}),c.update(),this.undoCount++,this.setCtxFile([]))},repeat:function(){var a=this.tabs.activeUuid(),b=this.undoPool[a],c=this.jh2d;if(this.undoCount>0){var d=null;0!==this.undoCount&&(d=b[b.length-this.undoCount],c.setData(d.data.sprites,d.data.options),c.update(),this.undoCount--,this.setCtxFile(d))}}},new i($("#jh2dEditor")),$('[data-toggle="tooltip"]').tooltip(),$('div[contenteditable="true"]').keypress(function(a){if(13!==a.which)return!0;var b=document.createDocumentFragment(),c=document.createTextNode("\n");b.appendChild(c),c=document.createElement("br"),b.appendChild(c);var d=window.getSelection().getRangeAt(0);d.deleteContents(),d.insertNode(b),d=document.createRange(),d.setStartAfter(c),d.collapse(!0);var e=window.getSelection();return e.removeAllRanges(),e.addRange(d),!1})});