/*! bootstrap-jh2d-editor 2015-05-16 */
$(document).ready(function(){function a(a){if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();b.selectNodeContents(a),b.collapse(!1);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if("undefined"!=typeof document.body.createTextRange){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}}$('[data-toggle="tooltip"]').tooltip();for(var b=document.getElementById("canvas1"),c=uuid.noConflict(),d=[{title:"untitled",data:{sprites:[{type:"larrow",x:280,y:200,w:100,h:60,text:"Hang",textOpt:{color:"#f00"}},{type:"line",x:100,y:100,w:100,h:60,conn:1},{type:"line",x:100,y:300,w:100,h:60,conn:1},{type:"ovalx",x:200,y:300,w:80,h:40,fillStyle:"#14A2D4",shadow:9,gradient:3,text:"hg",textOpt:{font:"Times",size:"80"},style:3}]}},{title:"untitled1",data:{sprites:[{type:"larrow",x:280,y:300,w:100,h:60,text:"Hang",textOpt:{color:"#f00"}}]}}],e=function(a){return $('<li data-file-uuid="'+a.uuid+'"><a href="#"><button class="close closeTab" type="button" ><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>'+a.title+'<i class="gb-unsaved"></i></a></li>').insertBefore($("#tab_files li").last())},f=0;f<d.length;f++){var g=d[f],h=c.v1();g.uuid=h,e(g)}$("#tab_files a:first").tab("show");var i=jh2d.instance(b,{background:1}).add(d[0].data.sprites).moveUp(2).show(),j=function(a){var b=k(a),c=null;return-1!==b&&(c=d[b]),c},k=function(a){for(var b=0;b<d.length;b++){var c=d[b];if(c.uuid===a)return b}return-1},l=function(){return $("#tab_files > li.active").data("file-uuid")},m=function(a){var b=j(a||l());return null!=b&&(b.data.sprites=i.data,b.data.options=i.options,$(".gb-unsaved",$("#tab_files > li.active")).text("*")),b},n=function(a){m();var b=j(a);i.setData(b.data.sprites,b.data.options),i.update()},o=function(a){var b=a.data("file-uuid");delete A[b],d.splice(k(b),1);var c=a.next();0===c.length&&(c=a.prev()),c.length>0&&(a.remove(),n(c.eq(0).data("file-uuid")),c.tab("show"))},p=!1,q=!1;$("body").on("dblclick",".btn-group button, .btn-group a",function(){p=!0}),$("body").on("click",".btn-group button, .btn-group a",function(){$(this).addClass("active"),$(this).siblings().removeClass("active");var a=$(this).data("gb-act-type"),c=$(this).data("gb-act-do");if(c)if(p)p=!1,s=null;else switch(a){case"shape":"text"!==c?i.newMode({type:c,fillStyle:"#fff"}):(q=!0,i.options.disabled=!0,b.style.cursor="text");break;case"zoom":var d=i.getScale();i.zoom(d+parseFloat(c));break;case"file":r(c);break;case"edit":t(c)}}),$("body").on("click",".closeTab",function(a){a.stopPropagation(),o($(this).parent().parent())}),$("body").on("click","#tab_files > a",function(a){a.preventDefault();var b=$(this).parent().data("file-uuid");-1!==b?(n(b),$(this).tab("show")):r("new")});var r=function(a){switch(a){case"new":var f={title:"Untitled"+(d.length+1)+"*",data:{sprites:[]}};d[d.length]=f;var g=c.v1();f.uuid=g,n(g);var h=$("#tab_files > li");e(f),$("#tab_files > a:eq("+(h.length-1)+")").tab("show");break;case"export":var i=b.toDataURL("image/png");window.open(i)}},s=null,t=function(a){switch(a){case"brush":-1!==v&&(s=jh2d.extend({},i.getSprite(v),!0,function(a){return!this.inArray(["style","fillStyle","gradient","shadow"],a)}));break;case"undo":E();break;case"repeat":F()}};$("body").on("mousedown","[class*='gb-ic-x']",function(a){var b=$(this).data("gb-act-do");b&&i.newMode({type:b,w:80,h:80,fillStyle:"#fff"},jh2d.ACT_NEW_DROP),a.preventDefault()});var u=!1;$("body").on("mouseup","#canvas1",function(){$(".btn-group button").removeClass("active"),u&&(m(),u=!1)}),$("body").on("mousemove","#canvas1",function(){var a=i.mDownFlag;a&&(u||-1===i.options.curIndex||(u=!0,D()))});var v=-1,w=!1;$("#canvas1").on("contextmenu",function(a){v=x(a.originalEvent);var b=$("#contextMenu");return-1!==v?($(".dropdown-submenu",b).addClass("disabled"),b.css({display:"block",left:a.pageX,top:a.pageY}),i.getSelectedCount()>1&&$(".dropdown-submenu",b).removeClass("disabled")):b.hide(),!1}),$("body").on("click","#canvas1",function(a){var c=$(this);$(".dropdown").hide();var d=i.getScale(),e=c.offset(),f=x(a.originalEvent),g=null;if(-1!==f){g=i.getSprite(f),s&&(D(),jh2d.extend(g,s,!0),i.update(),m());var h=$("#propPane");h.css({display:"block",left:e.left+(g.x+g.w)*d+10,top:e.top+g.y*d});var j=$('a[data-ssdlg-tabid="tab_image"]',h);g.img?(j.removeClass("hidden"),j.addClass("show")):(j.removeClass("show"),j.addClass("hidden"))}else $("#propPane").hide();var k=$("#textEdit");if(q){var l=k.html(),n=a.originalEvent,o=n.offsetX||n.layerX,r=n.offsetY||n.layerY;if(null!=l&&""!==l){if(q=!1,w){D();var t=k.offset();g={type:"rect",x:t.left-e.left,y:t.top-e.top+4,w:k.width(),h:k.height(),text:l,style:0,textOpt:{align:6}},i.add(g),i.options.disabled=!1,i.update(),m()}w=!1,k.hide()}else k.removeAttr("style"),k.css({display:"block",left:e.left+o,top:e.top+r,minHeight:24}).focus().text(""),w=!0,b.style.cursor="default"}else-1!==v&&w&&(D(),g=i.getSprite(v),g.text=k.html(),0===g.style&&jh2d.extend(g,{w:k.width(),h:k.height()},!0),i.update(),m(),k.text("").hide()),w=!1;return p||(s=null),v=f,!1});var x=function(a){var b=a.offsetX||a.layerX,c=a.offsetY||a.layerY,d=i.getScale();return b/=d,c/=d,i.indexOf(b,c)};$("body").on("dblclick","#canvas1",function(b){var c=$(this),d=i.getScale(),e=c.offset();if(v=x(b.originalEvent),-1!==v){var f=i.getSprite(v),g=e.left+f.x+f.w/4,h=e.top+f.y+f.h/4,j=jh2d.DEF_TEXT_OPT,k=12,l=f.w;if(f.text){j=f.textOpt,k=j.h.height,l=j.w.width;var m=j.x,n=j.y,o=j.align;m-=j.w.width/2,n-=k/2,(o&jh2d.EAST)===jh2d.EAST?m=j.x-j.w.width:(o&jh2d.WEST)===jh2d.WEST?m=j.x:(o&jh2d.SOUTH)===jh2d.SOUTH?n=j.y-k:(o&jh2d.NORTH)===jh2d.NORTH&&(n=j.y),g=e.left+m*d,h=e.top+n*d}var p=$("#textEdit");p.css({display:"block",left:g,top:h+4,minWidth:Math.max(f.w,l)*d,minHeight:f.h/2*d,fontFamily:j.font,fontStyle:j.style,fontWeight:j.weight,fontSize:j.size+"px",color:j.color,backgroundColor:"#fff",lineHeight:k+"px"}).focus().html(f.text||""),w=!0,a(p[0])}}),$("body").on("click","#contextMenu .dropdown-menu a",function(){$(".dropdown").hide();var a=$(this).data("gb-act-do");switch(D(),a){case"up":i.moveUp(v);break;case"down":i.moveDown(v);break;case"top":i.moveTop(v);break;case"bottom":i.moveBottom(v);break;case"grp":i.group();break;case"ungrp":i.ungroup();break;case"align-right":i.align(1);break;case"align-top":i.align(2);break;case"align-left":i.align(4);break;case"align-bottom":i.align(8);break;case"align-vcenter":i.align(5);break;case"align-hcenter":i.align(10)}i.update(),m()}),$("#textEdit").on("keydown",function(a){a.stopPropagation()});var y=null,z=0;$(document).bind("keydown","del backspace Ctrl+a Ctrl+c Ctrl+v Ctrl+n Ctrl+w Ctrl+z Ctrl+y",function(a){if(a.ctrlKey)switch(String.fromCharCode(a.which).toLowerCase()){case"a":i.selectAll().update();break;case"c":var b=i.getSelecteds();b.length>0&&(y=b);break;case"v":if(null!=y){for(var c=jh2d.clone(y),d=0;d<c.length;d++){var e=c[d];e.x+=10*(1+z),e.y+=10*(1+z)}D(),i.add(c).update(),z++,m()}break;case"n":r("new");break;case"w":o($("#tab_files > li.active"));break;case"z":E();break;case"y":F()}else switch(jQuery.hotkeys.specialKeys[a.which]){case"del":case"backspace":D(),i.removeSelected()&&i.update(),m()}return!1}).keydown(function(a){switch(jQuery.hotkeys.specialKeys[a.keyCode]){case"ctrl":i.setMultiSelect(!0)}}).keyup(function(a){switch(jQuery.hotkeys.specialKeys[a.keyCode]){case"ctrl":i.setMultiSelect(!1)}});var A={},B=10,C=0,D=function(){var a=l();A[a]||(A[a]=[]);var b={data:{sprites:jh2d.clone(i.data),options:jh2d.clone(i.options)}};C>0?(A[a].splice(A[a].length-C,C,b),C=0):(A[a].length>=B&&A[a].shift(),A[a].push(b))},E=function(){var a=l(),b=A[a],c=b[b.length-1-C];C<b.length&&(i.setData(c.data.sprites,c.data.options),i.update(),C++)},F=function(){if(C>0){var a=l();C--;var b=null;b=0!==C?A[a][A[a].length-C]:j(a),i.setData(b.data.sprites,b.data.options),i.update()}},G=$("#shapestyle-dialog");G.shapeStyleDialog(),G.on("optionChange",function(a){if(-1!==v){var b=i.getSprite(v),c=null;switch(console.log(a.key+":"+a.val),D(),a.key){case"r":b.rotate=a.val*Math.PI/180;break;case"gradient":var d=parseInt(a.val/4),e=a.val%4;switch(b.gradientType=0,b.gradientCnt=2,d){case 0:b.gradient=1;break;case 1:b.gradient=2;break;case 2:b.gradient=3;break;case 3:b.gradient=6;break;case 4:b.gradientType=1,b.gradient=15;break;case 5:b.gradientType=1,b.gradient=2>e?3:6}e%2!==0&&(b.gradient*=-1),5!==d&&e>1&&(b.gradientCnt=3),b.fillStyle=b.fillStyle||"#eee",b.style|=1;break;case"strokeSize":c=b.style||3,0===a.val?c&=-3:c|=2,b.style=c,b[a.key]=a.val;break;case"strokeStyle":if(c=b.style||3,null==a.val)c&=-3;else{b[a.key]=a.val;var f=$(a.target).shapeStyleDialog("option");f.strokeSize&&(c|=2,b.strokeSize=f.strokeSize)}b.style=c;break;case"fillStyle":c=b.style||3,null==a.val?c&=-2:c|=1,b.style=c,b[a.key]=a.val;break;case"alpha":b[a.key]=a.val/100;break;case"img":b[a.key]=a.val;break;case"shadow":8===a.val?b.shadowOffset=0:b.shadowOffset=5,b.shadowAngle=a.val*Math.PI/4;break;default:if(0===a.key.indexOf("font-")){var g=a.key.substring(5);b.textOpt=b.textOpt||{},b.textOpt[g]=a.val}else b[a.key]=a.val}console.log(b),i.update(),m()}}),G.on("imgload",function(a){var b=a.relatedTarget;jh2d.resource_cache[b.src]=b}),G.on("show.bs.modal",function(){if(-1!==v){var a=i.getSprite(v),b=$.extend({r:0,fillStyle:"#fff",strokeStyle:"#000"},a),c=null;for(c in b)switch(c){case"alpha":b.alpha*=100;break;case"rotate":b.r=Math.round(180*b.rotate/Math.PI);break;case"img":var d={};d.url=b.img.url,d.rect={x:b.img.x,y:b.img.y,w:b.img.w,h:b.img.h},b.img=d;break;case"shadowAngle":b.shadow=Math.round(4*b[c]/Math.PI);break;case"style":0===(1&b[c])&&(b.fillStyle=null)}if(b.textOpt){b.textOpt.decoration=b.textOpt.decoration||"";for(c in b.textOpt)b["font-"+c]=b.textOpt[c];delete b.textOpt}$(this).shapeStyleDialog("option",b)}}),G.on("shown.bs.modal",function(a){var b=$(a.relatedTarget),c=b.data("ssdlg-tabid"),d=$('.nav-tabs a[href="#'+c+'"]',$(this));"tab_image"===c&&d.parent().is(".active")?$(this).shapeStyleDialog("imgpickerUpdate"):d.tab("show")})});